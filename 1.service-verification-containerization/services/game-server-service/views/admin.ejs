<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            background: #4CAF50;
            color: white;
            border-radius: 4px;
            font-size: 12px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .section h3 {
            margin-top: 0;
            color: #555;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .stat-label {
            font-weight: 500;
            color: #666;
        }
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #2196F3;
        }
        .config-controls {
            margin-top: 15px;
        }
        .config-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .config-item label {
            min-width: 120px;
            font-weight: 500;
            color: #666;
        }
        .config-item input[type="range"] {
            flex: 1;
            margin: 0 10px;
        }
        .config-value {
            min-width: 80px;
            font-weight: bold;
            color: #333;
        }
        .config-item button {
            padding: 5px 15px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .config-item button:hover {
            background: #1976D2;
        }
        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .last-updated {
            font-size: 12px;
            color: #999;
            text-align: right;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ® <%= title %></h1>
            <span class="status">é‹è¡Œä¸­</span>
            <div class="last-updated" id="lastUpdated">æœ€å¾Œæ›´æ–°: <%= new Date().toLocaleString('zh-TW') %></div>
        </div>
        
        <div class="section">
            <h3>ğŸ“Š æœå‹™ç‹€æ…‹</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-label">æœå‹™åç¨±:</span>
                    <span class="stat-value"><%= service %></span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ç«¯å£:</span>
                    <span class="stat-value">8083</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">WebSocket é€£æ¥æ•¸:</span>
                    <span class="stat-value" id="connections"><%= connections %></span>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h3>ğŸŸ éŠæˆ²ç‹€æ…‹</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-label">æ´»èºéŠæˆ²æˆ¿é–“:</span>
                    <span class="stat-value" id="activeRooms"><%= stats.activeRooms %></span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">é­šç¾¤æ•¸é‡:</span>
                    <span class="stat-value" id="fishCount"><%= stats.fishCount %></span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">å­å½ˆæ•¸é‡:</span>
                    <span class="stat-value" id="bulletCount"><%= stats.bulletCount %></span>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h3>ğŸ’¥ ç¢°æ’æª¢æ¸¬</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-label">ä»Šæ—¥ç¢°æ’æ¬¡æ•¸:</span>
                    <span class="stat-value" id="todayCollisions"><%= stats.todayCollisions %></span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">å‘½ä¸­ç‡:</span>
                    <span class="stat-value" id="hitRateStats"><%= stats.hitRate %>%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ç¸½æ´¾å½©:</span>
                    <span class="stat-value" id="totalPayout">$<%= stats.totalPayout %></span>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h3>âš™ï¸ éŠæˆ²é…ç½®</h3>
            <div class="config-controls">
                <!-- é­šç¾¤ç”Ÿæˆé–“éš” -->
                <div class="config-item">
                    <label for="fishSpawnInterval">é­šç¾¤ç”Ÿæˆé–“éš”:</label>
                    <input type="range" id="fishSpawnInterval" 
                           min="100" max="5000" step="100" value="<%= config.fishSpawnInterval %>">
                    <span class="config-value" id="fishSpawnIntervalValue"><%= (config.fishSpawnInterval / 1000).toFixed(1) %>ç§’</span>
                    <button onclick="updateConfig('fishSpawnInterval')">æ‡‰ç”¨</button>
                </div>
                
                <!-- å­å½ˆé€Ÿåº¦ -->
                <div class="config-item">
                    <label for="bulletSpeed">å­å½ˆé€Ÿåº¦:</label>
                    <input type="range" id="bulletSpeed" 
                           min="300" max="800" step="10" value="<%= config.bulletSpeed %>">
                    <span class="config-value" id="bulletSpeedValue"><%= config.bulletSpeed %>px/s</span>
                    <button onclick="updateConfig('bulletSpeed')">æ‡‰ç”¨</button>
                </div>
                
                <!-- å‘½ä¸­ç‡ -->
                <div class="config-item">
                    <label for="hitRate">å‘½ä¸­ç‡:</label>
                    <input type="range" id="hitRate" 
                           min="0.1" max="1.0" step="0.05" value="<%= config.hitRate %>">
                    <span class="config-value" id="hitRateValue"><%= (config.hitRate * 100).toFixed(0) %>%</span>
                    <button onclick="updateConfig('hitRate')">æ‡‰ç”¨</button>
                </div>
            </div>
            
            <!-- é…ç½®ç‹€æ…‹æç¤º -->
            <div id="configStatus" class="status-message"></div>
        </div>
        
        <div class="section">
            <h3>ğŸ”— API ç«¯é»</h3>
            <ul>
                <li>GET /admin/api/stats - å³æ™‚çµ±è¨ˆæ•¸æ“š</li>
                <li>POST /admin/api/config/update - é…ç½®æ›´æ–°</li>
                <li>POST /api/v1/game/start - é–‹å§‹éŠæˆ²</li>
                <li>POST /api/v1/game/shoot - ç™¼å°„å­å½ˆ</li>
                <li>POST /api/v1/collision/detect - ç¢°æ’æª¢æ¸¬</li>
            </ul>
        </div>
        
        <div class="section">
            <h3>ğŸŒ WebSocket äº‹ä»¶</h3>
            <ul>
                <li>join-room - åŠ å…¥æˆ¿é–“</li>
                <li>fire-bullet - ç™¼å°„å­å½ˆ</li>
                <li>game-state-update - éŠæˆ²ç‹€æ…‹æ›´æ–°</li>
                <li>config-update - é…ç½®æ›´æ–°é€šçŸ¥</li>
            </ul>
        </div>
    </div>

    <script>
        // ç®¡ç†é¢æ¿å³æ™‚æ•¸æ“šæ›´æ–°
        const AdminDashboard = {
            // æ¯ç§’æ›´æ–°çµ±è¨ˆæ•¸æ“š
            updateInterval: 1000,
            
            // çµ±è¨ˆæ•¸æ“šçµæ§‹
            stats: {
                activeRooms: 0,
                fishCount: 0,
                bulletCount: 0,
                todayCollisions: 0,
                hitRate: 0,
                totalPayout: 0
            },
            
            // é…ç½®æ•¸æ“šçµæ§‹
            config: {
                fishSpawnInterval: <%= config.fishSpawnInterval %>,
                bulletSpeed: <%= config.bulletSpeed %>,
                hitRate: <%= config.hitRate %>
            },
            
            // åˆå§‹åŒ–å³æ™‚æ›´æ–°
            init() {
                this.startStatsUpdate();
                this.bindConfigControls();
                console.log('Admin Dashboard initialized');
            },
            
            // é–‹å§‹çµ±è¨ˆæ•¸æ“šæ›´æ–°
            startStatsUpdate() {
                setInterval(() => {
                    this.fetchStats();
                }, this.updateInterval);
            },
            
            // ç²å–å³æ™‚çµ±è¨ˆæ•¸æ“š
            async fetchStats() {
                try {
                    const response = await fetch('/admin/api/stats');
                    const result = await response.json();
                    
                    if (result.success) {
                        this.updateStatsDisplay(result.data);
                        this.updateLastUpdatedTime();
                    }
                } catch (error) {
                    console.error('Error fetching stats:', error);
                }
            },
            
            // æ›´æ–°çµ±è¨ˆæ•¸æ“šé¡¯ç¤º
            updateStatsDisplay(data) {
                document.getElementById('activeRooms').textContent = data.activeRooms;
                document.getElementById('fishCount').textContent = data.fishCount;
                document.getElementById('bulletCount').textContent = data.bulletCount;
                document.getElementById('todayCollisions').textContent = data.todayCollisions;
                document.getElementById('hitRateStats').textContent = data.hitRate + '%';
                document.getElementById('totalPayout').textContent = '$' + data.totalPayout;
            },
            
            // æ›´æ–°æœ€å¾Œæ›´æ–°æ™‚é–“
            updateLastUpdatedTime() {
                const now = new Date().toLocaleString('zh-TW');
                document.getElementById('lastUpdated').textContent = 'æœ€å¾Œæ›´æ–°: ' + now;
            },
            
            // ç¶å®šé…ç½®æ§åˆ¶é …äº‹ä»¶
            bindConfigControls() {
                // é­šç¾¤ç”Ÿæˆé–“éš”æ»‘æ¡¿
                const fishSpawnInterval = document.getElementById('fishSpawnInterval');
                fishSpawnInterval.addEventListener('input', (e) => {
                    const value = (e.target.value / 1000).toFixed(1);
                    document.getElementById('fishSpawnIntervalValue').textContent = value + 'ç§’';
                });
                
                // å­å½ˆé€Ÿåº¦æ»‘æ¡¿
                const bulletSpeed = document.getElementById('bulletSpeed');
                bulletSpeed.addEventListener('input', (e) => {
                    document.getElementById('bulletSpeedValue').textContent = e.target.value + 'px/s';
                });
                
                // å‘½ä¸­ç‡æ»‘æ¡¿
                const hitRate = document.getElementById('hitRate');
                hitRate.addEventListener('input', (e) => {
                    const value = (e.target.value * 100).toFixed(0);
                    document.getElementById('hitRateValue').textContent = value + '%';
                });
            },
            
            // é¡¯ç¤ºç‹€æ…‹è¨Šæ¯
            showStatusMessage(message, type) {
                const statusDiv = document.getElementById('configStatus');
                statusDiv.textContent = message;
                statusDiv.className = 'status-message ' + type;
                statusDiv.style.display = 'block';
                
                // 3ç§’å¾Œéš±è—è¨Šæ¯
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }
        };
        
        // æ›´æ–°é…ç½®
        async function updateConfig(configKey) {
            try {
                const element = document.getElementById(configKey);
                if (!element) {
                    AdminDashboard.showStatusMessage(`æ‰¾ä¸åˆ°é…ç½®å…ƒç´ : ${configKey}`, 'error');
                    return;
                }
                
                let value;
                
                // æ ¹æ“šé…ç½®é¡å‹è™•ç†æ•¸å€¼
                if (configKey === 'fishSpawnInterval' || configKey === 'bulletSpeed') {
                    value = parseInt(element.value);
                    if (isNaN(value)) {
                        AdminDashboard.showStatusMessage(`ç„¡æ•ˆçš„æ•¸å€¼: ${element.value}`, 'error');
                        return;
                    }
                } else if (configKey === 'hitRate') {
                    value = parseFloat(element.value);
                    if (isNaN(value)) {
                        AdminDashboard.showStatusMessage(`ç„¡æ•ˆçš„æ•¸å€¼: ${element.value}`, 'error');
                        return;
                    }
                } else {
                    value = parseFloat(element.value);
                    if (isNaN(value)) {
                        AdminDashboard.showStatusMessage(`ç„¡æ•ˆçš„æ•¸å€¼: ${element.value}`, 'error');
                        return;
                    }
                }
                
                console.log(`Updating ${configKey} to ${value} (type: ${typeof value})`);
                
                const response = await fetch('/admin/api/config/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [configKey]: value })
                });
                
                const result = await response.json();
                console.log('Update result:', result);
                
                if (result.success && result.results[configKey] && result.results[configKey].success) {
                    AdminDashboard.showStatusMessage(`${configKey} å·²æ›´æ–°ç‚º ${value}`, 'success');
                } else {
                    const error = result.results && result.results[configKey] ? result.results[configKey].error : result.message || 'æœªçŸ¥éŒ¯èª¤';
                    AdminDashboard.showStatusMessage(`é…ç½®æ›´æ–°å¤±æ•—: ${error}`, 'error');
                }
            } catch (error) {
                console.error('Error updating config:', error);
                AdminDashboard.showStatusMessage('é…ç½®æ›´æ–°å¤±æ•—: ç¶²è·¯éŒ¯èª¤', 'error');
            }
        }
        
        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            AdminDashboard.init();
        });
    </script>
</body>
</html>