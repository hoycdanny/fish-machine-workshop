<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŸ å¤šäººæ•é­šæ©ŸéŠæˆ²</title>
    <script>
        // éŠæˆ²é…ç½® - å¯ç”±å¾Œç«¯æ³¨å…¥æˆ–ä½¿ç”¨é»˜èªå€¼
        window.GAME_CONFIG = {
            API_BASE: '{{API_BASE}}' !== '{{API_BASE}}' ? '{{API_BASE}}' : 'http://localhost:8082',
            GAME_SERVER: '{{GAME_SERVER}}' !== '{{GAME_SERVER}}' ? '{{GAME_SERVER}}' : 'http://localhost:8083'
        };
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            position: relative;
        }

        .game-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: visible;
            width: 1420px;
            height: auto;
            display: flex;
            flex-direction: column;
            margin: 0 auto;
            position: relative;
        }

        .game-header {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .score {
            background: #e74c3c;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .room-info {
            background: #9b59b6;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .game-area {
            width: 1400px;
            height: 700px;
            background: linear-gradient(to bottom, #4a90e2, #2c5aa0);
            position: relative;
            overflow: hidden;
            cursor: crosshair;
            border: 3px solid #1e3a5f;
            border-radius: 10px;
            margin: 5px auto;
        }

        .game-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(ellipse 400px 200px at 20% 80%, rgba(30, 144, 255, 0.15) 0%, transparent 70%),
                radial-gradient(ellipse 300px 150px at 80% 20%, rgba(65, 105, 225, 0.12) 0%, transparent 65%),
                radial-gradient(ellipse 350px 180px at 40% 60%, rgba(100, 149, 237, 0.1) 0%, transparent 60%);
            animation: wave-movement 8s ease-in-out infinite;
            pointer-events: none;
            z-index: 2;
        }

        .game-area::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(ellipse 350px 180px at 70% 30%, rgba(30, 144, 255, 0.12) 0%, transparent 65%),
                radial-gradient(ellipse 280px 140px at 25% 70%, rgba(65, 105, 225, 0.1) 0%, transparent 60%),
                radial-gradient(ellipse 320px 160px at 60% 85%, rgba(100, 149, 237, 0.08) 0%, transparent 55%);
            animation: wave-movement-reverse 10s ease-in-out infinite;
            pointer-events: none;
            z-index: 2;
        }

        @keyframes wave-movement {

            0%,
            100% {
                transform: translateX(0) translateY(0) scale(1) rotate(0deg);
                opacity: 1;
            }

            25% {
                transform: translateX(15px) translateY(-8px) scale(1.1) rotate(1deg);
                opacity: 0.8;
            }

            50% {
                transform: translateX(-8px) translateY(15px) scale(0.9) rotate(-1deg);
                opacity: 0.6;
            }

            75% {
                transform: translateX(-12px) translateY(-10px) scale(1.05) rotate(0.5deg);
                opacity: 0.9;
            }
        }

        @keyframes wave-movement-reverse {

            0%,
            100% {
                transform: translateX(0) translateY(0) scale(1) rotate(0deg);
                opacity: 1;
            }

            30% {
                transform: translateX(-12px) translateY(18px) scale(1.08) rotate(-1.5deg);
                opacity: 0.7;
            }

            60% {
                transform: translateX(18px) translateY(-9px) scale(0.92) rotate(1.2deg);
                opacity: 0.5;
            }

            90% {
                transform: translateX(-6px) translateY(-15px) scale(1.03) rotate(-0.8deg);
                opacity: 0.8;
            }
        }

        .fish {
            position: absolute;
            cursor: pointer;
            transition: transform 0.2s ease;
            z-index: 15;
        }

        .fish:hover {
            transform: scale(1.1);
        }

        .fish.small {
            font-size: 30px;
        }

        .fish.medium {
            font-size: 45px;
        }

        .fish.large {
            font-size: 60px;
        }

        .fish.boss {
            font-size: 90px;
        }

        .bullet {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            z-index: 12;
            /* èƒŒæ™¯é¡è‰²å’Œé™°å½±å°‡ç”±JavaScriptå‹•æ…‹è¨­ç½® */
        }

        .controls {
            background: #34495e;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .control-group {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .login-form {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 400px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        /* å¼·åˆ¶éš±è—æ¨¡æ…‹æ¡† */
        #roomSelectionModal.hidden {
            display: none !important;
        }

        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 10000;
            max-width: 300px;
            word-wrap: break-word;
        }

        .status.success {
            background-color: #27ae60;
        }

        .status.error {
            background-color: #e74c3c;
        }

        .status.info {
            background-color: #3498db;
        }

        .status.warning {
            background-color: #f39c12;
        }

        .auto-mode-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #ecf0f1;
            font-size: 14px;
            cursor: pointer;
            padding: 8px 12px;
            background: rgba(52, 73, 94, 0.8);
            border-radius: 5px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .auto-mode-label:hover {
            background: rgba(52, 73, 94, 1);
            border-color: #3498db;
        }

        .auto-mode-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .auto-mode-label.active {
            background: rgba(46, 204, 113, 0.2);
            border-color: #2ecc71;
            color: #2ecc71;
        }

        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
        }

        .status.success {
            background: #27ae60;
        }

        .status.error {
            background: #e74c3c;
        }

        .status.info {
            background: #3498db;
        }

        .players-list {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 25;
        }

        .explosion {
            position: absolute;
            font-size: 40px;
            color: #f39c12;
            animation: explode 0.5s ease-out;
            z-index: 25;
        }

        @keyframes explode {
            0% {
                transform: scale(0.5);
                opacity: 1;
            }

            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        /* æ¨¡æ…‹æ¡†æ¨£å¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
        }

        .modal-body {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .modal-footer {
            background: #ecf0f1;
            padding: 15px 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .rooms-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .room-item {
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .room-item:hover {
            border-color: #3498db;
            background: #f8f9fa;
        }

        .room-item.full {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .room-item.full:hover {
            border-color: #bdc3c7;
            background: white;
        }

        .room-info h3 {
            margin: 0 0 5px 0;
            color: #2c3e50;
        }

        .room-info p {
            margin: 0;
            color: #7f8c8d;
            font-size: 14px;
        }

        .room-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }

        .players-count {
            background: #3498db;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .players-count.full {
            background: #e74c3c;
        }

        .room-status-badge {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: bold;
        }

        .room-status-badge.waiting {
            background: #f39c12;
            color: white;
        }

        .room-status-badge.playing {
            background: #27ae60;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .no-rooms {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
    </style>
</head>

<body>
    <!-- ç™»å…¥è¡¨å–® -->
    <div id="loginForm" class="login-form">
        <h1>ğŸŸ å¤šäººæ•é­šæ©Ÿ</h1>
        <p style="margin-bottom: 30px; color: #7f8c8d;">æ­¡è¿ä¾†åˆ°æµ·åº•ä¸–ç•Œï¼</p>

        <div class="form-group">
            <label for="username">ç”¨æˆ¶å</label>
            <input type="text" id="username" placeholder="è«‹è¼¸å…¥ç”¨æˆ¶å">
        </div>

        <div class="form-group">
            <label for="password">å¯†ç¢¼</label>
            <input type="password" id="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
        </div>

        <button class="btn btn-primary" onclick="login()" style="width: 100%; margin-bottom: 10px;">ç™»å…¥éŠæˆ²</button>
        <button class="btn btn-success" onclick="register()" style="width: 100%;">è¨»å†Šå¸³è™Ÿ</button>
    </div>

    <!-- éŠæˆ²ä¸»ç•Œé¢ -->
    <div id="gameContainer" class="game-container hidden">
        <div class="game-header">
            <div>
                <h1>ğŸŸ å¤šäººæ•é­šæ©Ÿ</h1>
                <span class="room-info" id="roomInfo">æœªåŠ å…¥æˆ¿é–“</span>
            </div>
            <div class="user-info">
                <span>ç©å®¶: <span id="playerName">-</span></span>
                <span class="score">é¤˜é¡: <span id="playerBalance">0</span> ğŸ’°</span>
                <span class="score">ç¸½åˆ†: <span id="playerScore">0</span> ğŸ†</span>
                <button class="btn btn-danger" onclick="logout()">ç™»å‡º</button>
            </div>
        </div>

        <div class="game-area" id="gameArea">
            <!-- ç©å®¶åˆ—è¡¨ -->
            <div class="players-list" id="playersList">
                <div><strong>æˆ¿é–“ç©å®¶:</strong></div>
            </div>
            <!-- é­šã€å­å½ˆæœƒå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
        </div>

        <div class="controls">
            <div class="control-group">
                <button class="btn btn-primary" id="findRoomBtn">å°‹æ‰¾æˆ¿é–“</button>
                <button class="btn btn-info" id="selectRoomBtn">é¸æ“‡æˆ¿é–“</button>
                <button class="btn btn-success" id="createRoomBtn">å‰µå»ºæˆ¿é–“</button>
            </div>
            <div class="control-group">
                <button class="btn btn-success" id="startGameBtn" disabled>é–‹å§‹éŠæˆ²</button>
                <button class="btn btn-primary" id="leaveRoomBtn" disabled>é›¢é–‹æˆ¿é–“</button>
            </div>
            <div class="control-group">
                <label class="auto-mode-label">
                    <input type="checkbox" id="autoModeCheckbox">
                    <span>ğŸ¤– é‚Šç·£äººæ¨¡å¼ (è‡ªå‹•å°„æ“Š)</span>
                </label>
            </div>
        </div>
    </div>

    <!-- æˆ¿é–“é¸æ“‡æ¨¡æ…‹æ¡† -->
    <div id="roomSelectionModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>é¸æ“‡æˆ¿é–“</h2>
                <button class="close-btn" onclick="closeRoomSelection()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="roomsList" class="rooms-list">
                    <div class="loading">è¼‰å…¥ä¸­...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="refreshRoomsList()">é‡æ–°æ•´ç†</button>
                <button class="btn btn-danger" onclick="closeRoomSelection()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // å‹•æ…‹è¼‰å…¥ Socket.IO
        function loadSocketIO() {
            return new Promise((resolve, reject) => {
                // æª¢æŸ¥æ˜¯å¦å·²ç¶“è¼‰å…¥
                if (typeof io !== 'undefined') {
                    console.log('Socket.IO å·²ç¶“è¼‰å…¥');
                    resolve();
                    return;
                }

                const script = document.createElement('script');
                script.src = `${window.GAME_CONFIG?.GAME_SERVER || 'http://localhost:8083'}/socket.io/socket.io.js`;

                // è¨­ç½®è¶…æ™‚
                const timeout = setTimeout(() => {
                    console.error('Socket.IO è¼‰å…¥è¶…æ™‚');
                    reject(new Error('Socket.IO è¼‰å…¥è¶…æ™‚'));
                }, 10000); // 10ç§’è¶…æ™‚

                script.onload = () => {
                    clearTimeout(timeout);
                    console.log('Socket.IO è¼‰å…¥æˆåŠŸ');
                    resolve();
                };

                script.onerror = () => {
                    clearTimeout(timeout);
                    console.error('ç„¡æ³•è¼‰å…¥ Socket.IO åº«');
                    reject(new Error('Socket.IO è¼‰å…¥å¤±æ•—'));
                };

                document.head.appendChild(script);
            });
        }
    </script>
    <script>
        // å…¨å±€è®Šæ•¸
        let currentUser = null;
        let socket = null;
        let gameState = {
            isPlaying: false,
            roomId: null,
            players: {},
            fishes: {},
            bullets: {},
            score: 0,
            balance: 0
        };

        // é‚Šç·£äººæ¨¡å¼è®Šæ•¸
        let autoModeEnabled = false;
        let autoModeInterval = null;

        // API åŸºç¤ URL - å¾ç’°å¢ƒè®Šæ•¸æˆ–ç•¶å‰åŸŸåç²å–
        const API_BASE = window.GAME_CONFIG?.API_BASE || 'http://localhost:8082';
        const GAME_SERVER = window.GAME_CONFIG?.GAME_SERVER || 'http://localhost:8083';

        // èª¿è©¦æ¨¡å¼
        const DEBUG = true;
        function debugLog(...args) {
            if (DEBUG) {
                console.log('[DEBUG]', ...args);
            }
        }

        // é¡¯ç¤ºç‹€æ…‹è¨Šæ¯
        function showStatus(message, type = 'success') {
            const existingStatus = document.querySelector('.status');
            if (existingStatus) {
                existingStatus.remove();
            }

            const status = document.createElement('div');
            status.className = `status ${type}`;
            status.textContent = message;
            document.body.appendChild(status);

            setTimeout(() => {
                if (status.parentNode) {
                    status.parentNode.removeChild(status);
                }
            }, 3000);
        }

        // ç”¨æˆ¶è¨»å†Š
        async function register() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!username || !password) {
                showStatus('è«‹å¡«å¯«ç”¨æˆ¶åå’Œå¯†ç¢¼', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/v1/users/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (data.success) {
                    showStatus('è¨»å†ŠæˆåŠŸï¼è«‹ç™»å…¥');
                } else {
                    showStatus(data.message || 'è¨»å†Šå¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('è¨»å†ŠéŒ¯èª¤:', error);
                showStatus('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æœå‹™æ˜¯å¦æ­£å¸¸é‹è¡Œ', 'error');
            }
        }

        // ç”¨æˆ¶ç™»å…¥
        async function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!username || !password) {
                showStatus('è«‹å¡«å¯«ç”¨æˆ¶åå’Œå¯†ç¢¼', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/v1/users/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (data.success) {
                    currentUser = {
                        username,
                        token: data.data.token,
                        userId: data.data.userId,
                        balance: data.data.balance || 1000
                    };

                    // åˆå§‹åŒ–éŠæˆ²ç‹€æ…‹
                    gameState.balance = currentUser.balance;

                    // æ›´æ–° UI é¡¯ç¤º
                    document.getElementById('playerName').textContent = username;
                    document.getElementById('playerBalance').textContent = currentUser.balance;

                    // åˆ‡æ›åˆ°éŠæˆ²ç•Œé¢
                    document.getElementById('loginForm').classList.add('hidden');
                    document.getElementById('gameContainer').classList.remove('hidden');

                    // é€£æ¥ WebSocket
                    connectWebSocket();

                    showStatus('ç™»å…¥æˆåŠŸï¼è«‹å‰µå»ºæˆ–åŠ å…¥æˆ¿é–“é–‹å§‹éŠæˆ²');
                } else {
                    showStatus(data.message || 'ç™»å…¥å¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('ç™»å…¥éŒ¯èª¤:', error);
                showStatus('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æœå‹™æ˜¯å¦æ­£å¸¸é‹è¡Œ', 'error');
            }
        }

        // ç™»å‡º
        function logout() {
            // é—œé–‰è‡ªå‹•æ¨¡å¼
            if (autoModeEnabled) {
                const checkbox = document.getElementById('autoModeCheckbox');
                if (checkbox) {
                    checkbox.checked = false;
                    toggleAutoMode();
                }
            }

            if (socket) {
                socket.disconnect();
            }
            currentUser = null;
            gameState = { isPlaying: false, roomId: null, players: {}, fishes: {}, bullets: {}, score: 0, balance: 0 };

            document.getElementById('gameContainer').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');

            // æ¸…ç©ºè¡¨å–®
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';

            // é‡ç½®UI
            updateUI();

            showStatus('å·²ç™»å‡º');
        }

        // é€£æ¥ WebSocket
        function connectWebSocket() {
            // å¦‚æœå·²ç¶“æœ‰é€£æ¥ï¼Œå…ˆæ–·é–‹
            if (socket && socket.connected) {
                socket.disconnect();
            }

            socket = io(GAME_SERVER);

            socket.on('connect', () => {
                console.log('WebSocket é€£æ¥æˆåŠŸ');
                showStatus('éŠæˆ²ä¼ºæœå™¨é€£æ¥æˆåŠŸ', 'info');
            });

            socket.on('disconnect', () => {
                console.log('WebSocket é€£æ¥æ–·é–‹');
                showStatus('èˆ‡éŠæˆ²ä¼ºæœå™¨æ–·é–‹é€£æ¥', 'error');
            });

            // æˆåŠŸåŠ å…¥æˆ¿é–“
            socket.on('joined-room', (data) => {
                console.log('æ”¶åˆ° joined-room äº‹ä»¶:', data);

                if (!data || !data.roomId) {
                    console.error('joined-room äº‹ä»¶æ•¸æ“šç„¡æ•ˆ:', data);
                    showStatus('åŠ å…¥æˆ¿é–“å¤±æ•—ï¼šæ•¸æ“šç„¡æ•ˆ', 'error');
                    return;
                }

                // å…ˆæ¸…ç†ä¹‹å‰çš„æˆ¿é–“ç‹€æ…‹
                clearGameArea();
                gameState.players = {};
                gameState.fishes = {};
                gameState.bullets = {};
                gameState.isPlaying = false;

                // è¨­ç½®æ–°æˆ¿é–“ç‹€æ…‹
                gameState.roomId = data.roomId;

                // å®‰å…¨åœ°è™•ç† gameState æ•¸æ“š
                const serverGameState = data.gameState || {};
                gameState.players = serverGameState.players || {};
                gameState.fishes = serverGameState.fishes || {};
                gameState.bullets = serverGameState.bullets || {};
                gameState.isPlaying = serverGameState.isActive || false;

                console.log('æ›´æ–°å¾Œçš„éŠæˆ²ç‹€æ…‹:', gameState);

                updateUI();
                updatePlayersDisplay();
                updateGameArea();

                showStatus(`å·²åŠ å…¥æˆ¿é–“: ${data.roomId}`, 'success');
            });

            // æ–°ç©å®¶åŠ å…¥
            socket.on('player-joined', (data) => {
                if (data && data.playerId && data.player) {
                    gameState.players[data.playerId] = data.player;
                    updatePlayersDisplay();
                    showStatus(`${data.username || 'ç©å®¶'} åŠ å…¥äº†æˆ¿é–“`, 'info');
                }
            });

            // ç©å®¶é›¢é–‹
            socket.on('player-left', (data) => {
                if (data && data.playerId && gameState.players[data.playerId]) {
                    delete gameState.players[data.playerId];
                    updatePlayersDisplay();
                    showStatus(`ç©å®¶é›¢é–‹äº†æˆ¿é–“`, 'info');
                }
            });

            // éŠæˆ²é–‹å§‹
            socket.on('game-started', (data) => {
                console.log('æ”¶åˆ° game-started äº‹ä»¶:', data);
                gameState.isPlaying = true;
                updateUI();
                showStatus('éŠæˆ²é–‹å§‹ï¼é»æ“ŠéŠæˆ²å€åŸŸé€²è¡Œå°„æ“Š', 'success');
            });

            // é­šç¾¤ç”Ÿæˆ
            socket.on('fish-spawned', (fish) => {
                if (fish && fish.id && fish.roomId === gameState.roomId) {
                    console.log(`[å‰ç«¯] æ”¶åˆ°é­šé¡ç”Ÿæˆäº‹ä»¶: ${fish.id}, ç•¶å‰æˆ¿é–“: ${gameState.roomId}, é­šé¡ç¸½æ•¸: ${Object.keys(gameState.fishes).length + 1}`);
                    gameState.fishes[fish.id] = fish;
                    createFishElement(fish);
                } else if (fish && fish.id) {
                    console.log(`[å‰ç«¯] å¿½ç•¥å…¶ä»–æˆ¿é–“çš„é­šé¡: ${fish.id}, é­šé¡æˆ¿é–“: ${fish.roomId}, ç•¶å‰æˆ¿é–“: ${gameState.roomId}`);
                }
            });

            // é­šç¾¤ç§»å‹•
            socket.on('fish-moved', (data) => {
                if (data && data.fishId && gameState.fishes[data.fishId]) {
                    gameState.fishes[data.fishId].x = data.x;
                    gameState.fishes[data.fishId].y = data.y;
                    updateFishPosition(data.fishId, data.x, data.y);
                }
            });

            // å­å½ˆç™¼å°„
            socket.on('bullet-fired', (bullet) => {
                if (bullet && bullet.id) {
                    gameState.bullets[bullet.id] = bullet;
                    createBulletElement(bullet);
                }
            });

            // é¤˜é¡æ›´æ–°
            socket.on('balance-updated', (data) => {
                console.log('[å‰ç«¯] æ”¶åˆ°é¤˜é¡æ›´æ–°:', data);
                if (data && data.balance !== undefined) {
                    gameState.balance = data.balance;
                    currentUser.balance = data.balance;

                    // æ›´æ–°é¤˜é¡é¡¯ç¤º
                    const balanceElement = document.getElementById('playerBalance');
                    if (balanceElement) {
                        balanceElement.textContent = data.balance;
                        console.log('[å‰ç«¯] é¤˜é¡é¡¯ç¤ºå·²æ›´æ–°ç‚º:', data.balance);
                    }

                    // æ›´æ–°éŠæˆ²ç‹€æ…‹é¡¯ç¤º
                    updateGameStatus();

                    // é¡¯ç¤ºé¤˜é¡è®ŠåŒ–æç¤º
                    if (data.change && data.reason) {
                        const changeText = data.change > 0 ? `+${data.change}` : `${data.change}`;
                        const reasonText = data.reason === 'bullet_fired' ? 'ç™¼å°„å­å½ˆ' : 'æ“Šä¸­é­šé¡';
                        showStatus(`${reasonText}: ${changeText} ğŸ’°`, data.change > 0 ? 'success' : 'info');
                    }
                }
            });

            // é¤˜é¡ä¸è¶³
            socket.on('insufficient-balance', (data) => {
                showStatus(data.message || 'é¤˜é¡ä¸è¶³ï¼Œç„¡æ³•ç™¼å°„å­å½ˆ', 'error');
            });

            // å­å½ˆç§»å‹•
            socket.on('bullet-moved', (data) => {
                if (data && data.bulletId && data.x !== undefined && data.y !== undefined) {
                    updateBulletPosition(data.bulletId, data.x, data.y);
                }
            });

            // ç¢°æ’å‘½ä¸­
            socket.on('collision-hit', (data) => {
                if (!data || !data.fishId || !data.bulletId) return;

                // ç²å–é­šçš„ä½ç½®ç”¨æ–¼çˆ†ç‚¸æ•ˆæœ
                const fish = gameState.fishes[data.fishId];

                // ç§»é™¤é­šå’Œå­å½ˆ
                if (gameState.fishes[data.fishId]) {
                    delete gameState.fishes[data.fishId];
                }
                if (gameState.bullets[data.bulletId]) {
                    delete gameState.bullets[data.bulletId];
                }

                removeFishElement(data.fishId);
                removeBulletElement(data.bulletId);

                // æ›´æ–°ç©å®¶åˆ†æ•¸å’Œé¤˜é¡
                if (data.playerId && gameState.players[data.playerId]) {
                    // æ›´æ–°ç©å®¶æ•¸æ“š
                    if (data.newScore !== undefined) {
                        gameState.players[data.playerId].score = data.newScore;
                    }
                    if (data.newBalance !== undefined) {
                        gameState.players[data.playerId].balance = data.newBalance;
                    }
                }

                // å¦‚æœæ˜¯ç•¶å‰ç”¨æˆ¶ï¼ŒåŒæ™‚æ›´æ–°UI
                if (data.playerId === currentUser?.userId) {
                    if (data.newScore !== undefined) {
                        gameState.score = data.newScore;
                        const scoreElement = document.getElementById('playerScore');
                        if (scoreElement) {
                            scoreElement.textContent = gameState.score;
                        }
                    }

                    if (data.newBalance !== undefined) {
                        gameState.balance = data.newBalance;
                        currentUser.balance = data.newBalance;
                        const balanceElement = document.getElementById('playerBalance');
                        if (balanceElement) {
                            balanceElement.textContent = gameState.balance;
                        }
                    }

                    showStatus(`å‘½ä¸­ï¼ç²å¾— ${data.reward || 0} åˆ† ğŸ’°`, 'success');
                }

                // æ›´æ–°ç©å®¶åˆ—è¡¨é¡¯ç¤º
                updatePlayersDisplay();

                // é¡¯ç¤ºçˆ†ç‚¸æ•ˆæœ
                if (fish && fish.x !== undefined && fish.y !== undefined) {
                    showExplosion(fish.x, fish.y);
                }
            });

            // å­å½ˆéæœŸ
            socket.on('bullet-expired', (data) => {
                if (data && data.bulletId && gameState.bullets[data.bulletId]) {
                    delete gameState.bullets[data.bulletId];
                    removeBulletElement(data.bulletId);
                }
            });
        }

        // å°‹æ‰¾æˆ¿é–“
        async function findRoom() {
            debugLog('å°‹æ‰¾æˆ¿é–“æŒ‰éˆ•è¢«é»æ“Š');

            if (!currentUser) {
                debugLog('ç”¨æˆ¶æœªç™»å…¥');
                showStatus('è«‹å…ˆç™»å…¥', 'error');
                return;
            }

            try {
                debugLog('ç™¼é€å°‹æ‰¾æˆ¿é–“è«‹æ±‚');
                const response = await fetch(`${API_BASE}/api/v1/matching/find-room`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUser.userId,
                        nickname: currentUser.username,
                        balance: 1000
                    })
                });

                const data = await response.json();
                debugLog('å°‹æ‰¾æˆ¿é–“éŸ¿æ‡‰:', data);

                if (data.success) {
                    if (data.data.roomId) {
                        joinRoom(data.data.roomId);
                    } else {
                        showStatus(data.message, 'info');
                    }
                } else {
                    showStatus(data.message || 'å°‹æ‰¾æˆ¿é–“å¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('å°‹æ‰¾æˆ¿é–“éŒ¯èª¤:', error);
                showStatus('ç¶²è·¯éŒ¯èª¤', 'error');
            }
        }

        // å‰µå»ºæˆ¿é–“
        let isCreatingRoom = false; // å…¨å±€æ¨™è¨˜é˜²æ­¢é‡è¤‡å‰µå»º
        async function createRoom() {
            console.log('[å‰ç«¯] å‰µå»ºæˆ¿é–“å‡½æ•¸è¢«èª¿ç”¨');
            debugLog('å‰µå»ºæˆ¿é–“æŒ‰éˆ•è¢«é»æ“Š');

            if (!currentUser) {
                debugLog('ç”¨æˆ¶æœªç™»å…¥');
                showStatus('è«‹å…ˆç™»å…¥', 'error');
                return;
            }

            // é˜²æ­¢é‡è¤‡é»æ“Š - ä½¿ç”¨å…¨å±€æ¨™è¨˜
            if (isCreatingRoom) {
                debugLog('æ­£åœ¨å‰µå»ºæˆ¿é–“ä¸­ï¼Œå¿½ç•¥é‡è¤‡é»æ“Š');
                return;
            }

            const createBtn = document.getElementById('createRoomBtn');
            if (createBtn.disabled) {
                debugLog('æŒ‰éˆ•å·²ç¦ç”¨ï¼Œå¿½ç•¥é‡è¤‡é»æ“Š');
                return;
            }

            // è¨­ç½®å‰µå»ºæ¨™è¨˜å’Œç¦ç”¨æŒ‰éˆ•
            isCreatingRoom = true;
            createBtn.disabled = true;
            createBtn.textContent = 'å‰µå»ºä¸­...';

            try {
                debugLog('ç™¼é€å‰µå»ºæˆ¿é–“è«‹æ±‚');
                const response = await fetch(`${API_BASE}/api/v1/lobby/rooms/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: `${currentUser.username}çš„æˆ¿é–“`,
                        maxPlayers: 4
                    })
                });

                const data = await response.json();
                debugLog('å‰µå»ºæˆ¿é–“éŸ¿æ‡‰:', data);

                if (data.success) {
                    showStatus('æˆ¿é–“å‰µå»ºæˆåŠŸ', 'success');
                    // å»¶é²ä¸€ä¸‹å†åŠ å…¥æˆ¿é–“ï¼Œç¢ºä¿æˆ¿é–“å·²ç¶“å®Œå…¨å‰µå»º
                    setTimeout(() => {
                        joinRoom(data.data.roomId);
                    }, 100);
                } else {
                    showStatus(data.message || 'å‰µå»ºæˆ¿é–“å¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('å‰µå»ºæˆ¿é–“éŒ¯èª¤:', error);
                showStatus('ç¶²è·¯éŒ¯èª¤', 'error');
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹å’Œæ¨™è¨˜
                setTimeout(() => {
                    isCreatingRoom = false;
                    createBtn.disabled = false;
                    createBtn.textContent = 'å‰µå»ºæˆ¿é–“';
                }, 1000); // å»¶é²1ç§’æ¢å¾©ï¼Œé˜²æ­¢å¿«é€Ÿé‡è¤‡é»æ“Š
            }
        }

        // åŠ å…¥æˆ¿é–“
        async function joinRoom(roomId) {
            if (!currentUser) {
                showStatus('è«‹å…ˆç™»å…¥', 'error');
                return;
            }

            try {
                // å…ˆé€šçŸ¥éŠæˆ²æœƒè©±æœå‹™
                const response = await fetch(`${API_BASE}/api/v1/lobby/rooms/${roomId}/join`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUser.userId,
                        username: currentUser.username
                    })
                });

                const data = await response.json();
                if (!data.success) {
                    showStatus(data.message || 'åŠ å…¥æˆ¿é–“å¤±æ•—', 'error');
                    return;
                }

                // å†é€šçŸ¥éŠæˆ²ä¼ºæœå™¨
                if (socket) {
                    const balanceToSend = currentUser.balance || gameState.balance || 1000;
                    console.log(`[å‰ç«¯] ç™¼é€ join-room äº‹ä»¶ï¼Œé¤˜é¡: ${balanceToSend}`);
                    socket.emit('join-room', {
                        roomId: roomId,
                        userId: currentUser.userId,
                        username: currentUser.username,
                        balance: balanceToSend
                    });
                }
            } catch (error) {
                console.error('åŠ å…¥æˆ¿é–“éŒ¯èª¤:', error);
                showStatus('ç¶²è·¯éŒ¯èª¤', 'error');
            }
        }

        // é›¢é–‹æˆ¿é–“
        async function leaveRoom() {
            if (!currentUser || !gameState.roomId) {
                return;
            }

            try {
                // å…ˆé€šçŸ¥éŠæˆ²æœƒè©±æœå‹™
                const response = await fetch(`${API_BASE}/api/v1/lobby/rooms/${gameState.roomId}/leave`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUser.userId
                    })
                });

                // å†é€šçŸ¥éŠæˆ²ä¼ºæœå™¨
                if (socket) {
                    socket.emit('leave-room', {
                        roomId: gameState.roomId,
                        userId: currentUser.userId
                    });
                }
            } catch (error) {
                console.error('é›¢é–‹æˆ¿é–“éŒ¯èª¤:', error);
            }

            // é—œé–‰è‡ªå‹•æ¨¡å¼
            if (autoModeEnabled) {
                const checkbox = document.getElementById('autoModeCheckbox');
                if (checkbox) {
                    checkbox.checked = false;
                    toggleAutoMode();
                }
            }

            gameState.roomId = null;
            gameState.players = {};
            gameState.fishes = {};
            gameState.bullets = {};
            gameState.isPlaying = false;

            clearGameArea();
            updateUI();

            showStatus('å·²é›¢é–‹æˆ¿é–“', 'info');
        }

        // é–‹å§‹éŠæˆ²
        function startGame() {
            console.log('é–‹å§‹éŠæˆ²æŒ‰éˆ•è¢«é»æ“Š');
            console.log('ç•¶å‰éŠæˆ²ç‹€æ…‹:', gameState);

            if (!gameState.roomId) {
                showStatus('è«‹å…ˆåŠ å…¥æˆ¿é–“', 'error');
                return;
            }

            if (!socket) {
                showStatus('WebSocket é€£æ¥æœªå»ºç«‹', 'error');
                return;
            }

            if (!socket.connected) {
                showStatus('WebSocket é€£æ¥å·²æ–·é–‹', 'error');
                return;
            }

            console.log('ç™¼é€ start-game äº‹ä»¶åˆ°æˆ¿é–“:', gameState.roomId);
            showStatus('æ­£åœ¨é–‹å§‹éŠæˆ²...', 'info');

            socket.emit('start-game', {
                roomId: gameState.roomId
            });
        }

        // éŠæˆ²å€åŸŸé»æ“Šäº‹ä»¶
        function setupGameAreaClick() {
            const gameArea = document.getElementById('gameArea');
            gameArea.addEventListener('click', (event) => {
                if (!gameState.isPlaying || !gameState.roomId) return;

                const rect = gameArea.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;

                // ç™¼å°„å­å½ˆ
                fireBulletAt(x, y);
            });
        }

        // ç™¼å°„å­å½ˆåˆ°æŒ‡å®šä½ç½®
        function fireBulletAt(targetX, targetY) {
            if (!socket || !currentUser || !gameState.isPlaying || !gameState.roomId) return;

            const gameArea = document.getElementById('gameArea');
            // å­å½ˆå¾éŠæˆ²å€åŸŸåº•éƒ¨é‚Šç·£ä¸­å¤®ç™¼å°„
            const startX = 700;   // æ©«å‘æ­£ä¸­é–“ (1400/2)
            const startY = 699;   // æœ€ä¸‹é¢é‚Šç·£ (700-1)

            // è¨ˆç®—æ–¹å‘ï¼šå¾åº•éƒ¨ä¸­å¤®æŒ‡å‘é»æ“Šä½ç½®
            const directionX = targetX - startX;
            const directionY = targetY - startY;

            // æ­£è¦åŒ–æ–¹å‘å‘é‡
            const length = Math.sqrt(directionX * directionX + directionY * directionY);
            const normalizedX = directionX / length;
            const normalizedY = directionY / length;

            // è¨ˆç®—å­å½ˆæ‡‰è©²é£›åˆ°çš„æœ€çµ‚ä½ç½®
            // ä½¿ç”¨å›ºå®šçš„éŠæˆ²å€åŸŸå°ºå¯¸
            const gameAreaWidth = 1400;
            const gameAreaHeight = 700;

            let finalTargetX, finalTargetY;

            // ç›´æ¥ä½¿ç”¨é»æ“Šä½ç½®ä½œç‚ºç›®æ¨™ï¼Œä¸é™åˆ¶å°„æ“Šè§’åº¦
            finalTargetX = targetX;
            finalTargetY = targetY;

            // ç¢ºä¿ç›®æ¨™ä½ç½®åœ¨éŠæˆ²å€åŸŸå…§
            finalTargetX = Math.max(0, Math.min(gameAreaWidth, finalTargetX));
            finalTargetY = Math.max(0, Math.min(gameAreaHeight, finalTargetY));

            // èª¿è©¦ä¿¡æ¯ï¼šé¡¯ç¤ºéŠæˆ²å€åŸŸå°ºå¯¸å’Œç›®æ¨™ä½ç½®
            console.log(`[DEBUG] Game area size: 1400x700 (fixed)`);
            console.log(`[DEBUG] Click position: (${targetX}, ${targetY})`);
            console.log(`[DEBUG] Final target: (${finalTargetX}, ${finalTargetY})`);

            socket.emit('fire-bullet', {
                roomId: gameState.roomId,
                userId: currentUser.userId,
                x: startX,
                y: startY,
                targetX: finalTargetX,
                targetY: finalTargetY,
                gameAreaWidth: 1400,
                gameAreaHeight: 700
            });
        }

        // æ‰¾åˆ°æœ€è¿‘çš„é­š
        function findNearestFish() {
            let nearestFish = null;
            let minDistance = Infinity;

            for (const fishId in gameState.fishes) {
                const fish = gameState.fishes[fishId];
                if (fish && fish.x !== undefined && fish.y !== undefined) {
                    // è¨ˆç®—è·é›¢ï¼ˆå¾éŠæˆ²å€åŸŸåº•éƒ¨é‚Šç·£ä¸­å¤®åˆ°é­šçš„è·é›¢ï¼‰
                    const gameArea = document.getElementById('gameArea');
                    const centerX = 700;   // æ©«å‘æ­£ä¸­é–“ (1400/2)
                    const bottomY = 699;   // æœ€ä¸‹é¢é‚Šç·£ (700-1)

                    const distance = Math.sqrt(
                        Math.pow(fish.x - centerX, 2) +
                        Math.pow(fish.y - bottomY, 2)
                    );

                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestFish = fish;
                    }
                }
            }

            return nearestFish;
        }

        // è‡ªå‹•å°„æ“Šå‡½æ•¸
        function autoShoot() {
            if (!autoModeEnabled || !gameState.isPlaying || !gameState.roomId) return;

            // æª¢æŸ¥é¤˜é¡
            if (currentUser && currentUser.balance <= 0) {
                console.log('[è‡ªå‹•æ¨¡å¼] é¤˜é¡ä¸è¶³ï¼Œåœæ­¢è‡ªå‹•å°„æ“Š');
                return;
            }

            const nearestFish = findNearestFish();
            if (nearestFish) {
                console.log('[è‡ªå‹•æ¨¡å¼] ç„æº–é­šé¡:', nearestFish.type, 'ä½ç½®:', nearestFish.x, nearestFish.y);
                fireBulletAt(nearestFish.x, nearestFish.y);
            }
        }

        // åˆ‡æ›è‡ªå‹•æ¨¡å¼
        function toggleAutoMode() {
            const checkbox = document.getElementById('autoModeCheckbox');
            const label = checkbox.parentElement;

            autoModeEnabled = checkbox.checked;

            if (autoModeEnabled) {
                label.classList.add('active');
                // æ¯1.5ç§’è‡ªå‹•å°„æ“Šä¸€æ¬¡
                autoModeInterval = setInterval(autoShoot, 1500);
                showStatus('ğŸ¤– é‚Šç·£äººæ¨¡å¼å·²å•Ÿå‹•ï¼è‡ªå‹•ç„æº–å°„æ“Šä¸­...', 'info');
                console.log('[è‡ªå‹•æ¨¡å¼] å·²å•Ÿå‹•');
            } else {
                label.classList.remove('active');
                if (autoModeInterval) {
                    clearInterval(autoModeInterval);
                    autoModeInterval = null;
                }
                showStatus('ğŸ¤– é‚Šç·£äººæ¨¡å¼å·²é—œé–‰', 'info');
                console.log('[è‡ªå‹•æ¨¡å¼] å·²é—œé–‰');
            }
        }

        // å‰µå»ºé­šå…ƒç´ 
        function createFishElement(fish) {
            const gameArea = document.getElementById('gameArea');
            const fishElement = document.createElement('div');
            fishElement.className = `fish ${fish.type}`;
            fishElement.id = `fish-${fish.id}`;
            fishElement.style.left = fish.x + 'px';
            fishElement.style.top = fish.y + 'px';

            // æ ¹æ“šé­šçš„é¡å‹è¨­ç½®ä¸åŒçš„è¡¨æƒ…ç¬¦è™Ÿ
            const fishEmojis = {
                small: 'ğŸ ',
                medium: 'ğŸŸ',
                large: 'ğŸ¡',
                boss: 'ğŸ¦ˆ'
            };
            fishElement.textContent = fishEmojis[fish.type] || 'ğŸŸ';

            gameArea.appendChild(fishElement);
        }

        // æ›´æ–°é­šçš„ä½ç½®
        function updateFishPosition(fishId, x, y) {
            const fishElement = document.getElementById(`fish-${fishId}`);
            if (fishElement) {
                fishElement.style.left = x + 'px';
                fishElement.style.top = y + 'px';
            }
        }

        // ç§»é™¤é­šå…ƒç´ 
        function removeFishElement(fishId) {
            const fishElement = document.getElementById(`fish-${fishId}`);
            if (fishElement) {
                fishElement.remove();
            }
        }

        // å‰µå»ºå­å½ˆå…ƒç´ 
        function createBulletElement(bullet) {
            const gameArea = document.getElementById('gameArea');
            const bulletElement = document.createElement('div');
            bulletElement.className = 'bullet';
            bulletElement.id = `bullet-${bullet.id}`;

            // çµ±ä¸€æ‰€æœ‰å­å½ˆéƒ½å¾åº•éƒ¨é‚Šç·£ä¸­å¤®ç™¼å°„
            const startX = 700;   // æ©«å‘æ­£ä¸­é–“ (1400/2)
            const startY = 699;   // æœ€ä¸‹é¢é‚Šç·£ (700-1)

            bulletElement.style.left = startX + 'px';
            bulletElement.style.top = startY + 'px';

            // è¨­ç½®å­å½ˆé¡è‰²èˆ‡ç©å®¶é¡è‰²åŒ¹é…
            const playerColor = getPlayerColor(bullet.playerId);
            bulletElement.style.backgroundColor = playerColor;
            bulletElement.style.borderColor = playerColor;
            bulletElement.style.boxShadow = `0 0 8px ${playerColor}`;

            console.log(`[DEBUG] å‰µå»ºå­å½ˆ ${bullet.id}ï¼Œç©å®¶ ${bullet.playerId}ï¼Œé¡è‰² ${playerColor}`);

            gameArea.appendChild(bulletElement);
        }

        // æ›´æ–°å­å½ˆä½ç½®
        function updateBulletPosition(bulletId, x, y) {
            const bulletElement = document.getElementById(`bullet-${bulletId}`);
            if (bulletElement) {
                // æ­£å¸¸æ›´æ–°ä½ç½®ï¼Œè®“å­å½ˆæŒ‰ç…§æœå‹™å™¨è¨ˆç®—çš„è»Œè·¡ç§»å‹•
                bulletElement.style.left = x + 'px';
                bulletElement.style.top = y + 'px';
            }
        }

        // ç§»é™¤å­å½ˆå…ƒç´ 
        function removeBulletElement(bulletId) {
            const bulletElement = document.getElementById(`bullet-${bulletId}`);
            if (bulletElement) {
                bulletElement.remove();
            }
        }

        // é¡¯ç¤ºçˆ†ç‚¸æ•ˆæœ
        function showExplosion(x, y) {
            const gameArea = document.getElementById('gameArea');
            const explosion = document.createElement('div');
            explosion.className = 'explosion';
            explosion.textContent = 'ğŸ’¥';
            explosion.style.left = x + 'px';
            explosion.style.top = y + 'px';

            gameArea.appendChild(explosion);

            setTimeout(() => {
                if (explosion.parentNode) {
                    explosion.parentNode.removeChild(explosion);
                }
            }, 500);
        }

        // ç©å®¶é¡è‰²é…ç½®
        const playerColors = [
            '#f39c12', // æ©™è‰²
            '#e74c3c', // ç´…è‰²
            '#00bfff', // äº®è—è‰² (Deep Sky Blue)
            '#2ecc71', // ç¶ è‰²
            '#9b59b6', // ç´«è‰²
            '#e67e22', // æ·±æ©™è‰²
            '#1abc9c', // é’è‰²
            '#34495e'  // æ·±ç°è‰²
        ];

        // ç²å–ç©å®¶é¡è‰²
        function getPlayerColor(playerId) {
            // ç‚ºæ¯å€‹ç©å®¶åˆ†é…å›ºå®šé¡è‰²
            const playerIds = Object.keys(gameState.players).sort();
            const playerIndex = playerIds.indexOf(playerId);
            return playerColors[playerIndex % playerColors.length];
        }

        // æ›´æ–°ç©å®¶åˆ—è¡¨é¡¯ç¤º
        function updatePlayersDisplay() {
            const playersList = document.getElementById('playersList');
            playersList.innerHTML = '<div><strong>æˆ¿é–“ç©å®¶:</strong></div>';

            console.log('[DEBUG] æ›´æ–°ç©å®¶åˆ—è¡¨ï¼Œç•¶å‰ç©å®¶æ•¸æ“š:', gameState.players);

            // é¡¯ç¤ºç•¶å‰æˆ¿é–“çš„æ‰€æœ‰ç©å®¶
            if (gameState.players && Object.keys(gameState.players).length > 0) {
                for (const playerId in gameState.players) {
                    const player = gameState.players[playerId];
                    if (player && player.username) {
                        const playerDiv = document.createElement('div');
                        playerDiv.textContent = `${player.username}: ${player.score || 0} åˆ†`;

                        // è¨­ç½®ç©å®¶é¡è‰²
                        const playerColor = getPlayerColor(playerId);
                        playerDiv.style.color = playerColor;

                        // ç•¶å‰ç”¨æˆ¶åŠ ç²—é¡¯ç¤º
                        if (playerId === currentUser?.userId) {
                            playerDiv.style.fontWeight = 'bold';
                        }

                        playersList.appendChild(playerDiv);
                    }
                }
            } else {
                // å¦‚æœæ²’æœ‰å…¶ä»–ç©å®¶æ•¸æ“šï¼Œè‡³å°‘é¡¯ç¤ºç•¶å‰ç”¨æˆ¶
                if (currentUser) {
                    const playerDiv = document.createElement('div');
                    playerDiv.textContent = `${currentUser.username}: ${gameState.score || 0} åˆ†`;
                    playerDiv.style.color = getPlayerColor(currentUser.userId);
                    playerDiv.style.fontWeight = 'bold';
                    playersList.appendChild(playerDiv);
                }
            }
        }

        // æ›´æ–°éŠæˆ²ç‹€æ…‹é¡¯ç¤º
        function updateGameStatus() {
            const inRoom = gameState.roomId !== null;
            const isPlaying = gameState.isPlaying;

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.getElementById('findRoomBtn').disabled = inRoom;
            document.getElementById('createRoomBtn').disabled = inRoom;
            document.getElementById('selectRoomBtn').disabled = inRoom;
            document.getElementById('startGameBtn').disabled = !inRoom || isPlaying;
            document.getElementById('leaveRoomBtn').disabled = !inRoom;

            // æ›´æ–°åˆ†æ•¸å’Œé¤˜é¡
            document.getElementById('playerScore').textContent = gameState.score;
            // ç¢ºä¿é¤˜é¡é¡¯ç¤ºæ­£ç¢ºï¼Œå„ªå…ˆä½¿ç”¨ currentUser.balance
            const balanceToShow = currentUser?.balance !== undefined ? currentUser.balance : (gameState.balance || 0);
            document.getElementById('playerBalance').textContent = balanceToShow;
        }

        // æ›´æ–°éŠæˆ²å€åŸŸ
        function updateGameArea() {
            // æ¸…ç©ºç¾æœ‰å…ƒç´ 
            clearGameArea();

            // é‡æ–°å‰µå»ºé­šç¾¤
            for (const fishId in gameState.fishes) {
                createFishElement(gameState.fishes[fishId]);
            }

            // é‡æ–°å‰µå»ºå­å½ˆ
            for (const bulletId in gameState.bullets) {
                createBulletElement(gameState.bullets[bulletId]);
            }
        }

        // æ¸…ç©ºéŠæˆ²å€åŸŸ
        function clearGameArea() {
            const gameArea = document.getElementById('gameArea');
            const elementsToRemove = gameArea.querySelectorAll('.fish, .bullet, .explosion');
            elementsToRemove.forEach(element => element.remove());
        }

        // æ›´æ–°UIç‹€æ…‹
        function updateUI() {
            const inRoom = !!gameState.roomId;
            const isPlaying = gameState.isPlaying;

            // æ›´æ–°æˆ¿é–“ä¿¡æ¯
            document.getElementById('roomInfo').textContent = inRoom ? `æˆ¿é–“: ${gameState.roomId}` : 'æœªåŠ å…¥æˆ¿é–“';

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.getElementById('findRoomBtn').disabled = inRoom;
            document.getElementById('createRoomBtn').disabled = inRoom;
            document.getElementById('startGameBtn').disabled = !inRoom || isPlaying;
            document.getElementById('leaveRoomBtn').disabled = !inRoom;

            // æ›´æ–°åˆ†æ•¸å’Œé¤˜é¡
            document.getElementById('playerScore').textContent = gameState.score;
            // ç¢ºä¿é¤˜é¡é¡¯ç¤ºæ­£ç¢ºï¼Œå„ªå…ˆä½¿ç”¨ currentUser.balance
            const balanceToShow = currentUser?.balance !== undefined ? currentUser.balance : (gameState.balance || 0);
            document.getElementById('playerBalance').textContent = balanceToShow;

            // æ›´æ–°é¸æ“‡æˆ¿é–“æŒ‰éˆ•ç‹€æ…‹
            document.getElementById('selectRoomBtn').disabled = inRoom;
        }

        // æˆ¿é–“é¸æ“‡ç›¸é—œå‡½æ•¸
        async function selectRoom() {
            if (!currentUser) {
                showStatus('è«‹å…ˆç™»å…¥', 'error');
                return;
            }

            // é¡¯ç¤ºæ¨¡æ…‹æ¡†
            document.getElementById('roomSelectionModal').classList.remove('hidden');

            // è¼‰å…¥æˆ¿é–“åˆ—è¡¨
            await loadRoomsList();
        }

        async function loadRoomsList() {
            const roomsList = document.getElementById('roomsList');
            roomsList.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/api/v1/lobby/rooms`);
                const data = await response.json();

                if (data.success && data.data.rooms) {
                    const rooms = data.data.rooms;

                    if (rooms.length === 0) {
                        roomsList.innerHTML = '<div class="no-rooms">ç›®å‰æ²’æœ‰å¯ç”¨çš„æˆ¿é–“<br>è«‹å‰µå»ºæ–°æˆ¿é–“æˆ–ç¨å¾Œå†è©¦</div>';
                        return;
                    }

                    // éæ¿¾å‡ºæœ‰ç©ºä½çš„æˆ¿é–“
                    const availableRooms = rooms.filter(room => room.currentPlayers < room.maxPlayers);

                    if (availableRooms.length === 0) {
                        roomsList.innerHTML = '<div class="no-rooms">æ‰€æœ‰æˆ¿é–“éƒ½å·²æ»¿<br>è«‹å‰µå»ºæ–°æˆ¿é–“æˆ–ç¨å¾Œå†è©¦</div>';
                        return;
                    }

                    // ç”Ÿæˆæˆ¿é–“åˆ—è¡¨ HTML
                    roomsList.innerHTML = availableRooms.map(room => {
                        const isFull = room.currentPlayers >= room.maxPlayers;
                        const statusText = room.status === 'playing' ? 'éŠæˆ²ä¸­' : 'ç­‰å¾…ä¸­';
                        const statusClass = room.status === 'playing' ? 'playing' : 'waiting';

                        return `
                            <div class="room-item ${isFull ? 'full' : ''}" onclick="${isFull ? '' : `joinRoomFromSelection('${room.id}')`}">
                                <div class="room-info">
                                    <h3>${room.name}</h3>
                                    <p>æˆ¿é–“ ID: ${room.id}</p>
                                    <p>å‰µå»ºæ™‚é–“: ${new Date(room.createdAt).toLocaleString()}</p>
                                </div>
                                <div class="room-status">
                                    <div class="players-count ${isFull ? 'full' : ''}">${room.currentPlayers}/${room.maxPlayers}</div>
                                    <div class="room-status-badge ${statusClass}">${statusText}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    roomsList.innerHTML = '<div class="no-rooms">è¼‰å…¥æˆ¿é–“åˆ—è¡¨å¤±æ•—<br>è«‹ç¨å¾Œå†è©¦</div>';
                }
            } catch (error) {
                console.error('è¼‰å…¥æˆ¿é–“åˆ—è¡¨éŒ¯èª¤:', error);
                roomsList.innerHTML = '<div class="no-rooms">ç¶²è·¯éŒ¯èª¤<br>è«‹æª¢æŸ¥é€£æ¥å¾Œé‡è©¦</div>';
            }
        }

        async function joinRoomFromSelection(roomId) {
            try {
                // é—œé–‰æ¨¡æ…‹æ¡†
                closeRoomSelection();

                // åŠ å…¥é¸ä¸­çš„æˆ¿é–“
                await joinRoom(roomId);

                showStatus(`æ­£åœ¨åŠ å…¥æˆ¿é–“ ${roomId}...`, 'info');
            } catch (error) {
                console.error('åŠ å…¥æˆ¿é–“éŒ¯èª¤:', error);
                showStatus('åŠ å…¥æˆ¿é–“å¤±æ•—', 'error');
            }
        }

        function closeRoomSelection() {
            console.log('[DEBUG] é—œé–‰æˆ¿é–“é¸æ“‡æ¨¡æ…‹æ¡†');
            const modal = document.getElementById('roomSelectionModal');
            modal.classList.add('hidden');
            modal.style.display = 'none'; // å¼·åˆ¶éš±è—
        }

        // æ·»åŠ æ¨¡æ…‹æ¡†èƒŒæ™¯é»æ“Šé—œé–‰åŠŸèƒ½
        function setupModalClickHandler() {
            const modal = document.getElementById('roomSelectionModal');
            const modalContent = modal.querySelector('.modal-content');

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeRoomSelection();
                }
            });

            // é˜²æ­¢æ¨¡æ…‹æ¡†å…§å®¹å€åŸŸçš„é»æ“Šäº‹ä»¶å†’æ³¡
            modalContent.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }

        // ç·Šæ€¥é—œé–‰æ¨¡æ…‹æ¡†å‡½æ•¸ï¼ˆå¯åœ¨æ§åˆ¶å°èª¿ç”¨ï¼‰
        window.forceCloseModal = function () {
            console.log('[DEBUG] å¼·åˆ¶é—œé–‰æ¨¡æ…‹æ¡†');
            const modal = document.getElementById('roomSelectionModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
                modal.style.visibility = 'hidden';
            }
        };

        // å¼·åˆ¶é‡ç½®UIç‹€æ…‹å‡½æ•¸ï¼ˆå¯åœ¨æ§åˆ¶å°èª¿ç”¨ï¼‰
        window.forceResetUI = function () {
            console.log('[DEBUG] å¼·åˆ¶é‡ç½®UIç‹€æ…‹');

            // é‡ç½®ç”¨æˆ¶ç‹€æ…‹
            currentUser = null;
            gameState = { isPlaying: false, roomId: null, players: {}, fishes: {}, bullets: {}, score: 0, balance: 0 };

            // å¼·åˆ¶é¡¯ç¤ºç™»å…¥ç•Œé¢
            const gameContainer = document.getElementById('gameContainer');
            const loginForm = document.getElementById('loginForm');

            gameContainer.classList.add('hidden');
            gameContainer.style.display = 'none !important';

            loginForm.classList.remove('hidden');
            loginForm.style.display = 'block !important';

            // é—œé–‰æ¨¡æ…‹æ¡†
            forceCloseModal();

            console.log('[DEBUG] UIç‹€æ…‹å·²é‡ç½®');
        };

        async function refreshRoomsList() {
            await loadRoomsList();
        }

        // é é¢åŠ è¼‰å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            debugLog('é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–');

            try {
                // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                showStatus('æ­£åœ¨åˆå§‹åŒ–éŠæˆ²...', 'info');

                // è¼‰å…¥ Socket.IO
                await loadSocketIO();
                debugLog('Socket.IO è¼‰å…¥æˆåŠŸ');

                // åˆå§‹åŒ–éŠæˆ²
                setupGameAreaClick();
                setupModalClickHandler();
                updateUI();

                // ç¢ºä¿æ­£ç¢ºçš„åˆå§‹UIç‹€æ…‹
                const modal = document.getElementById('roomSelectionModal');
                const gameContainer = document.getElementById('gameContainer');
                const loginForm = document.getElementById('loginForm');

                // ç¢ºä¿æ¨¡æ…‹æ¡†éš±è—
                modal.classList.add('hidden');

                // æ ¹æ“šç”¨æˆ¶ç™»å…¥ç‹€æ…‹è¨­ç½®UI
                if (!currentUser) {
                    // æœªç™»å…¥ï¼šé¡¯ç¤ºç™»å…¥è¡¨å–®ï¼Œéš±è—éŠæˆ²å®¹å™¨
                    gameContainer.classList.add('hidden');
                    loginForm.classList.remove('hidden');
                } else {
                    // å·²ç™»å…¥ï¼šé¡¯ç¤ºéŠæˆ²å®¹å™¨ï¼Œéš±è—ç™»å…¥è¡¨å–®
                    loginForm.classList.add('hidden');
                    gameContainer.classList.remove('hidden');
                }

                console.log('[DEBUG] åˆå§‹åŒ–å®Œæˆï¼ŒUIç‹€æ…‹å·²é‡ç½®');
                console.log('[DEBUG] æ¨¡æ…‹æ¡†ç‹€æ…‹:', modal.classList.contains('hidden'));
                console.log('[DEBUG] ç™»å…¥è¡¨å–®ç‹€æ…‹:', !loginForm.classList.contains('hidden'));

                // éš±è—è¼‰å…¥ç‹€æ…‹
                showStatus('éŠæˆ²åˆå§‹åŒ–å®Œæˆï¼è«‹è¨»å†Šæˆ–ç™»å…¥é–‹å§‹éŠæˆ²', 'success');
                debugLog('éŠæˆ²åˆå§‹åŒ–å®Œæˆ');

                // æ¸¬è©¦æŒ‰éˆ•äº‹ä»¶ç¶å®š
                const findRoomBtn = document.getElementById('findRoomBtn');
                const selectRoomBtn = document.getElementById('selectRoomBtn');
                const createRoomBtn = document.getElementById('createRoomBtn');
                const startGameBtn = document.getElementById('startGameBtn');

                debugLog('æŒ‰éˆ•å…ƒç´ :', {
                    findRoomBtn: !!findRoomBtn,
                    selectRoomBtn: !!selectRoomBtn,
                    createRoomBtn: !!createRoomBtn,
                    startGameBtn: !!startGameBtn
                });

                // æ‰‹å‹•ç¶å®šäº‹ä»¶ï¼ˆä»¥é˜²è¬ä¸€ï¼‰
                if (findRoomBtn) {
                    findRoomBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        debugLog('å°‹æ‰¾æˆ¿é–“æŒ‰éˆ•é»æ“Šäº‹ä»¶è§¸ç™¼');
                        findRoom();
                    });
                }

                if (selectRoomBtn) {
                    selectRoomBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        debugLog('é¸æ“‡æˆ¿é–“æŒ‰éˆ•é»æ“Šäº‹ä»¶è§¸ç™¼');
                        selectRoom();
                    });
                }

                if (createRoomBtn) {
                    createRoomBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        debugLog('å‰µå»ºæˆ¿é–“æŒ‰éˆ•é»æ“Šäº‹ä»¶è§¸ç™¼');
                        createRoom();
                    });
                }

                if (startGameBtn) {
                    startGameBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        debugLog('é–‹å§‹éŠæˆ²æŒ‰éˆ•é»æ“Šäº‹ä»¶è§¸ç™¼');
                        startGame();
                    });
                }

                // ç¶å®šé›¢é–‹æˆ¿é–“æŒ‰éˆ•äº‹ä»¶
                const leaveRoomBtn = document.getElementById('leaveRoomBtn');
                if (leaveRoomBtn) {
                    leaveRoomBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        debugLog('é›¢é–‹æˆ¿é–“æŒ‰éˆ•é»æ“Šäº‹ä»¶è§¸ç™¼');
                        leaveRoom();
                    });
                }

                // ç¶å®šé‚Šç·£äººæ¨¡å¼å‹¾é¸æ¡†äº‹ä»¶
                const autoModeCheckbox = document.getElementById('autoModeCheckbox');
                if (autoModeCheckbox) {
                    autoModeCheckbox.addEventListener('change', toggleAutoMode);
                    debugLog('é‚Šç·£äººæ¨¡å¼å‹¾é¸æ¡†äº‹ä»¶å·²ç¶å®š');
                }

            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±æ•—:', error);
                showStatus(`éŠæˆ²åˆå§‹åŒ–å¤±æ•—: ${error.message}`, 'error');

                // å³ä½¿ Socket.IO è¼‰å…¥å¤±æ•—ï¼Œä¹Ÿè¦è®“åŸºæœ¬åŠŸèƒ½å¯ç”¨
                try {
                    setupGameAreaClick();
                    updateUI();
                    showStatus('éƒ¨åˆ†åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'warning');
                } catch (fallbackError) {
                    console.error('å‚™ç”¨åˆå§‹åŒ–ä¹Ÿå¤±æ•—:', fallbackError);
                    showStatus('éŠæˆ²ç„¡æ³•å•Ÿå‹•ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥', 'error');
                }
            }
        });
    </script>
</body>

</html>