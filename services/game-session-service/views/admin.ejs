<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            background: #4CAF50;
            color: white;
            border-radius: 4px;
            font-size: 12px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .section h3 {
            margin-top: 0;
            color: #555;
        }
        .btn {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn:hover {
            opacity: 0.8;
        }
        .room-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .room-table th, .room-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .room-table th {
            background-color: #f2f2f2;
        }
        .room-controls {
            margin-bottom: 15px;
        }
        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            display: none;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ <%= title %></h1>
            <span class="status">é‹è¡Œä¸­</span>
        </div>
        
        <div class="section">
            <h3>ğŸ“Š æœå‹™ç‹€æ…‹</h3>
            <p>æœå‹™åç¨±: <%= service %></p>
            <p>å•Ÿå‹•æ™‚é–“: <%= new Date().toLocaleString('zh-TW') %></p>
            <p>ç«¯å£: 8082</p>
        </div>
        
        <div class="section">
            <h3>ğŸ‘¥ ç”¨æˆ¶ç®¡ç†</h3>
            <div class="status-message" id="userStatusMessage"></div>
            <div class="room-controls">
                <button class="btn btn-success" onclick="refreshUsers()">åˆ·æ–°ç”¨æˆ¶</button>
                <button class="btn btn-danger" onclick="clearAllUsers()">æ¸…ç©ºæ‰€æœ‰ç”¨æˆ¶</button>
            </div>
            
            <table class="room-table" id="userTable">
                <thead>
                    <tr>
                        <th>ç”¨æˆ¶ID</th>
                        <th>ç”¨æˆ¶å</th>
                        <th>é¤˜é¡</th>
                        <th>è¨»å†Šæ™‚é–“</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <tr>
                        <td colspan="5" style="text-align: center;">è¼‰å…¥ä¸­...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="section">
            <h3>ğŸ’° éŒ¢åŒ…ç®¡ç†</h3>
            <p>ç¸½é¤˜é¡: $<span id="totalBalance">0.00</span></p>
            <div class="room-controls">
                <button class="btn btn-success" onclick="refreshWalletData()">åˆ·æ–°éŒ¢åŒ…æ•¸æ“š</button>
            </div>
        </div>
        
        <div class="section">
            <h3>ğŸ  æˆ¿é–“ç®¡ç†</h3>
            <div class="status-message" id="statusMessage"></div>
            <div class="room-controls">
                <button class="btn btn-success" onclick="refreshRooms()">åˆ·æ–°æ•¸æ“š</button>
                <button class="btn btn-danger" onclick="clearAllRooms()">é—œé–‰æ‰€æœ‰æˆ¿é–“</button>
            </div>
            
            <table class="room-table" id="roomTable">
                <thead>
                    <tr>
                        <th>æˆ¿é–“ID</th>
                        <th>æˆ¿é–“åç¨±</th>
                        <th>ç©å®¶æ•¸</th>
                        <th>ç‹€æ…‹</th>
                        <th>å‰µå»ºæ™‚é–“</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="roomTableBody">
                    <tr>
                        <td colspan="6" style="text-align: center;">è¼‰å…¥ä¸­...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="section">
            <h3>ğŸ”— API ç«¯é»</h3>
            <ul>
                <li>POST /api/v1/users/register - ç”¨æˆ¶è¨»å†Š</li>
                <li>POST /api/v1/users/login - ç”¨æˆ¶ç™»å…¥</li>
                <li>GET /api/v1/wallet/balance/:userId - æŸ¥è©¢é¤˜é¡</li>
                <li>GET /api/v1/lobby/rooms - æˆ¿é–“åˆ—è¡¨</li>
                <li>POST /api/v1/lobby/rooms/create - å‰µå»ºæˆ¿é–“</li>
                <li>DELETE /api/v1/lobby/rooms/:roomId - åˆªé™¤æˆ¿é–“</li>
                <li>DELETE /api/v1/lobby/rooms - æ¸…ç©ºæ‰€æœ‰æˆ¿é–“</li>
                <li>POST /api/v1/matching/find-room - æ™ºèƒ½é…æ¡Œ</li>
            </ul>
        </div>
    </div>
    
    <script>
        // é¡¯ç¤ºç‹€æ…‹è¨Šæ¯
        function showMessage(message, type = 'success') {
            const messageDiv = document.getElementById('statusMessage');
            messageDiv.className = `status-message status-${type}`;
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }
        
        // åˆ·æ–°æˆ¿é–“åˆ—è¡¨
        async function refreshRooms() {
            try {
                const response = await fetch('/api/v1/lobby/rooms');
                const data = await response.json();
                
                if (data.success) {
                    updateRoomTable(data.data.rooms);
                    showMessage('æˆ¿é–“æ•¸æ“šå·²åˆ·æ–°');
                } else {
                    showMessage('åˆ·æ–°å¤±æ•—: ' + data.message, 'error');
                }
            } catch (error) {
                showMessage('ç¶²è·¯éŒ¯èª¤: ' + error.message, 'error');
            }
        }
        
        // æ›´æ–°æˆ¿é–“è¡¨æ ¼
        function updateRoomTable(rooms) {
            const tbody = document.getElementById('roomTableBody');
            
            if (rooms.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">æš«ç„¡æˆ¿é–“</td></tr>';
                return;
            }
            
            tbody.innerHTML = rooms.map(room => `
                <tr>
                    <td>${room.id}</td>
                    <td>${room.name}</td>
                    <td>${room.currentPlayers}/${room.maxPlayers}</td>
                    <td>${room.status}</td>
                    <td>${new Date(room.createdAt).toLocaleString('zh-TW')}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteRoom('${room.id}')">é—œé–‰</button>
                    </td>
                </tr>
            `).join('');
        }
        
        // åˆªé™¤å–®å€‹æˆ¿é–“
        async function deleteRoom(roomId) {
            if (!confirm(`ç¢ºå®šè¦é—œé–‰æˆ¿é–“ ${roomId} å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch('/admin/delete-room', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ roomId: roomId })
                });
                const data = await response.json();
                
                if (data.success) {
                    showMessage(`æˆ¿é–“ ${roomId} å·²é—œé–‰`);
                    refreshRooms();
                } else {
                    showMessage('é—œé–‰å¤±æ•—: ' + data.message, 'error');
                }
            } catch (error) {
                showMessage('ç¶²è·¯éŒ¯èª¤: ' + error.message, 'error');
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰æˆ¿é–“
        async function clearAllRooms() {
            if (!confirm('ç¢ºå®šè¦é—œé–‰æ‰€æœ‰æˆ¿é–“å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤éŠ·ï¼')) {
                return;
            }
            
            try {
                const response = await fetch('/admin/clear-rooms', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message);
                    refreshRooms();
                } else {
                    showMessage('æ¸…ç©ºå¤±æ•—: ' + data.message, 'error');
                }
            } catch (error) {
                showMessage('ç¶²è·¯éŒ¯èª¤: ' + error.message, 'error');
            }
        }
        
        // ç”¨æˆ¶ç®¡ç†åŠŸèƒ½
        function showUserMessage(message, type = 'success') {
            const messageDiv = document.getElementById('userStatusMessage');
            messageDiv.className = `status-message status-${type}`;
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }
        
        // åˆ·æ–°ç”¨æˆ¶åˆ—è¡¨
        async function refreshUsers() {
            try {
                const response = await fetch('/admin/users');
                const data = await response.json();
                
                if (data.success) {
                    updateUserTable(data.data.users);
                    showUserMessage('ç”¨æˆ¶æ•¸æ“šå·²åˆ·æ–°');
                } else {
                    showUserMessage('åˆ·æ–°å¤±æ•—: ' + data.message, 'error');
                }
            } catch (error) {
                showUserMessage('ç¶²è·¯éŒ¯èª¤: ' + error.message, 'error');
            }
        }
        
        // æ›´æ–°ç”¨æˆ¶è¡¨æ ¼
        function updateUserTable(users) {
            const tbody = document.getElementById('userTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">æš«ç„¡ç”¨æˆ¶</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.userId}</td>
                    <td>${user.username}</td>
                    <td>$${user.balance.toFixed(2)}</td>
                    <td>${new Date(user.createdAt).toLocaleString('zh-TW')}</td>
                    <td>
                        <button class="btn btn-primary" onclick="changePassword('${user.username}')">æ”¹å¯†ç¢¼</button>
                        <button class="btn btn-primary" onclick="adjustBalance('${user.username}', ${user.balance})">èª¿é¤˜é¡</button>
                        <button class="btn btn-danger" onclick="deleteUser('${user.username}')">åˆªé™¤</button>
                    </td>
                </tr>
            `).join('');
            
            // åŒæ™‚æ›´æ–°éŒ¢åŒ…çµ±è¨ˆæ•¸æ“š
            updateWalletStats(users);
        }
        
        // æ›´æ–°éŒ¢åŒ…çµ±è¨ˆæ•¸æ“š
        function updateWalletStats(users) {
            // è¨ˆç®—ç¸½é¤˜é¡
            const totalBalance = users.reduce((sum, user) => sum + user.balance, 0);
            document.getElementById('totalBalance').textContent = totalBalance.toFixed(2);
        }
        
        // åˆ·æ–°éŒ¢åŒ…æ•¸æ“š
        async function refreshWalletData() {
            try {
                const response = await fetch('/admin/users');
                const data = await response.json();
                
                if (data.success) {
                    updateWalletStats(data.data.users);
                    showMessage('éŒ¢åŒ…æ•¸æ“šå·²åˆ·æ–°');
                } else {
                    showMessage('åˆ·æ–°å¤±æ•—: ' + data.message, 'error');
                }
            } catch (error) {
                showMessage('ç¶²è·¯éŒ¯èª¤: ' + error.message, 'error');
            }
        }
        
        // åˆªé™¤ç”¨æˆ¶
        async function deleteUser(username) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ç”¨æˆ¶ ${username} å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch('/admin/delete-user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username: username })
                });
                const data = await response.json();
                
                if (data.success) {
                    showUserMessage(`ç”¨æˆ¶ ${username} å·²åˆªé™¤`);
                    refreshUsers();
                } else {
                    showUserMessage('åˆªé™¤å¤±æ•—: ' + data.message, 'error');
                }
            } catch (error) {
                showUserMessage('ç¶²è·¯éŒ¯èª¤: ' + error.message, 'error');
            }
        }
        
        // è®Šæ›´å¯†ç¢¼
        async function changePassword(username) {
            const newPassword = prompt(`è«‹è¼¸å…¥ç”¨æˆ¶ ${username} çš„æ–°å¯†ç¢¼:`);
            if (!newPassword) {
                return;
            }
            
            try {
                const response = await fetch('/admin/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username: username, newPassword: newPassword })
                });
                const data = await response.json();
                
                if (data.success) {
                    showUserMessage(`ç”¨æˆ¶ ${username} å¯†ç¢¼å·²è®Šæ›´`);
                } else {
                    showUserMessage('å¯†ç¢¼è®Šæ›´å¤±æ•—: ' + data.message, 'error');
                }
            } catch (error) {
                showUserMessage('ç¶²è·¯éŒ¯èª¤: ' + error.message, 'error');
            }
        }
        
        // èª¿æ•´é¤˜é¡
        async function adjustBalance(username, currentBalance) {
            const newBalance = prompt(`è«‹è¼¸å…¥ç”¨æˆ¶ ${username} çš„æ–°é¤˜é¡ (ç•¶å‰: $${currentBalance.toFixed(2)}):`);
            if (newBalance === null) {
                return;
            }
            
            const balance = parseFloat(newBalance);
            if (isNaN(balance)) {
                showUserMessage('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å­—', 'error');
                return;
            }
            
            try {
                const response = await fetch('/admin/adjust-balance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username: username, newBalance: balance })
                });
                const data = await response.json();
                
                if (data.success) {
                    showUserMessage(`ç”¨æˆ¶ ${username} é¤˜é¡å·²èª¿æ•´ç‚º $${balance.toFixed(2)}`);
                    refreshUsers();
                } else {
                    showUserMessage('é¤˜é¡èª¿æ•´å¤±æ•—: ' + data.message, 'error');
                }
            } catch (error) {
                showUserMessage('ç¶²è·¯éŒ¯èª¤: ' + error.message, 'error');
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰ç”¨æˆ¶
        async function clearAllUsers() {
            if (!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ç”¨æˆ¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤éŠ·ï¼')) {
                return;
            }
            
            try {
                const response = await fetch('/admin/clear-users', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    showUserMessage(data.message);
                    refreshUsers();
                } else {
                    showUserMessage('æ¸…ç©ºå¤±æ•—: ' + data.message, 'error');
                }
            } catch (error) {
                showUserMessage('ç¶²è·¯éŒ¯èª¤: ' + error.message, 'error');
            }
        }
        
        // é é¢è¼‰å…¥æ™‚è‡ªå‹•åˆ·æ–°æˆ¿é–“åˆ—è¡¨å’Œç”¨æˆ¶åˆ—è¡¨
        document.addEventListener('DOMContentLoaded', () => {
            refreshRooms();
            refreshUsers();
            refreshWalletData();
            
            // æ¯30ç§’è‡ªå‹•åˆ·æ–°ä¸€æ¬¡
            setInterval(() => {
                refreshRooms();
                refreshUsers();
            }, 30000);
        });
    </script>
</body>
</html>